---
name: Publish SDK to npm

on:
  # Manual workflow dispatch for controlled releases
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type (patch, minor, major, or exact version like 1.0.0-beta.2)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
          - custom
      custom_version:
        description: "Custom version (only used if version=custom)"
        required: false
        type: string
      tag:
        description: "npm dist-tag (latest, beta, next, etc.)"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - beta
          - next
          - alpha
      dry_run:
        description: "Dry run (will not publish)"
        required: false
        default: false
        type: boolean

  # Automatic publishing on GitHub releases
  release:
    types: [published]

permissions:
  contents: write
  id-token: write # Required for npm provenance

jobs:
  publish:
    name: Publish SDK to npm
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ ERROR: SDK can only be published from the main branch"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Current branch: ${{ github.ref_name }}"
            echo "Required branch: main"
            echo ""
            echo "ðŸ“‹ To publish the SDK, please follow these steps:"
            echo ""
            echo "1. Go to: Actions â†’ Publish SDK to npm"
            echo "2. Click 'Run workflow' button"
            echo "3. Select 'main' from the branch dropdown"
            echo "4. Configure your version bump options"
            echo "5. Click 'Run workflow'"
            echo ""
            echo "â„¹ï¸  Why this restriction?"
            echo "   Publishing from main ensures:"
            echo "   - Version consistency across the codebase"
            echo "   - Proper version bump tracking in git history"
            echo "   - Automated PR creation works correctly"
            echo "   - Release tags are created on the correct branch"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Also add to GitHub Actions summary
            echo "## âŒ Publishing Failed - Wrong Branch" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Required branch**: \`main\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ How to Fix" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Actions** â†’ **Publish SDK to npm**" >> $GITHUB_STEP_SUMMARY
            echo "2. Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
            echo "3. Select **main** from the branch dropdown" >> $GITHUB_STEP_SUMMARY
            echo "4. Configure your version bump options" >> $GITHUB_STEP_SUMMARY
            echo "5. Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â„¹ï¸ Why This Restriction?" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Publishing from main ensures:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Version consistency across the codebase" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Proper version bump tracking in git history" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Automated PR creation works correctly" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Release tags are created on the correct branch" >> $GITHUB_STEP_SUMMARY

            exit 1
          fi
          echo "âœ“ Branch validation passed: running on main"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm for Trusted Publishers
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          cd packages/sdk

          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (e.g., sdk-v1.0.0 -> 1.0.0)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#sdk-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing from release: $VERSION"
          elif [ "${{ inputs.version }}" = "custom" ]; then
            echo "version=${{ inputs.custom_version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "Publishing custom version: ${{ inputs.custom_version }}"
          else
            # Get the actual latest published version from npm (not just 'latest' tag)
            # This gets ALL published versions and picks the highest one
            PUBLISHED_VERSION=$(npm view @asce1062/music-service-sdk versions --json 2>/dev/null | jq -r '.[-1]' || echo "0.0.0")
            REPO_VERSION=$(node -p "require('./package.json').version")

            echo "Latest published version on npm (any tag): $PUBLISHED_VERSION"
            echo "Repository package.json version: $REPO_VERSION"

            # Sync package.json with npm if out of sync
            if [ "$PUBLISHED_VERSION" != "$REPO_VERSION" ] && [ "$PUBLISHED_VERSION" != "0.0.0" ]; then
              echo "âš ï¸  Versions out of sync! Syncing package.json to npm version: $PUBLISHED_VERSION"
              npm version $PUBLISHED_VERSION --no-git-tag-version --allow-same-version
            fi

            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "Base version for bump: $CURRENT_VERSION"

            # Get all npm metadata including tombstoned versions (in 'time' but not 'versions')
            NPM_METADATA=$(npm view @asce1062/music-service-sdk time --json 2>/dev/null || echo "{}")

            # Bump version and check for tombstones
            MAX_ATTEMPTS=10
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if [ "${{ inputs.version }}" = "prerelease" ]; then
                # For prerelease bumps, use --preid to specify the tag
                npm version prerelease --preid=${{ inputs.tag }} --no-git-tag-version
              else
                # For other bumps (patch, minor, major)
                npm version ${{ inputs.version }} --no-git-tag-version
              fi

              NEW_VERSION=$(node -p "require('./package.json').version")

              # Check if this version is tombstoned (exists in time but was unpublished)
              IS_TOMBSTONED=$(echo "$NPM_METADATA" | jq -r --arg ver "$NEW_VERSION" 'has($ver)')

              if [ "$IS_TOMBSTONED" = "true" ]; then
                echo "âš ï¸  Version $NEW_VERSION is tombstoned (unpublished), skipping to next version..."
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "âœ“ Version $NEW_VERSION is available for publishing"
                break
              fi
            done

            if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
              echo "âŒ Error: Could not find non-tombstoned version after $MAX_ATTEMPTS attempts"
              exit 1
            fi

            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "Publishing ${{ inputs.version }} bump: $CURRENT_VERSION -> $NEW_VERSION"
          fi

      - name: Update version in package.json
        if: github.event_name != 'release' && inputs.version == 'custom'
        run: |
          cd packages/sdk
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Run quality checks
        run: |
          cd packages/sdk
          echo "Running type checks..."
          npm run typecheck

          echo "Running linter..."
          npm run lint

          echo "Running format check..."
          npm run format:check

      - name: Run tests
        run: |
          cd packages/sdk
          echo "Running test suite..."
          npm run test:coverage

      - name: Build SDK
        run: |
          cd packages/sdk
          echo "Building SDK for all formats (ESM, CJS, IIFE, DTS)..."
          npm run build

      - name: Verify build artifacts
        run: |
          cd packages/sdk
          echo "Checking dist directory..."
          ls -lah dist/

          echo "Verifying required files exist..."
          test -f dist/index.js || (echo "Missing index.js" && exit 1)
          test -f dist/index.cjs || (echo "Missing index.cjs" && exit 1)
          test -f dist/index.d.ts || (echo "Missing index.d.ts" && exit 1)

          echo "âœ“ All build artifacts present"

      - name: Dry run publish
        if: inputs.dry_run == true
        run: |
          cd packages/sdk
          echo "DRY RUN: Would publish with:"
          npm publish --dry-run --tag ${{ steps.version.outputs.tag }}

      - name: Publish to npm
        if: inputs.dry_run != true
        working-directory: packages/sdk
        run: |
          echo "Publishing @asce1062/music-service-sdk@${{ steps.version.outputs.version }} to npm..."
          npm publish --tag ${{ steps.version.outputs.tag }} --access public
          echo "âœ… Published to npm with tag: ${{ steps.version.outputs.tag }}"
          echo ""
          echo "ðŸ“¦ Installation:"
          echo "  npm install @asce1062/music-service-sdk@${{ steps.version.outputs.tag }}"

      - name: Create Pull Request for version bump
        if: github.event_name != 'release' && inputs.dry_run != true
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(sdk): bump version to ${{ steps.version.outputs.version }}"
          title: "chore(sdk): Release v${{ steps.version.outputs.version }}"
          body: |
            ## ðŸ“¦ SDK Release v${{ steps.version.outputs.version }}

            This PR updates the package.json version after successful npm publication.

            ### Published Package
            - **Version**: `${{ steps.version.outputs.version }}`
            - **Tag**: `${{ steps.version.outputs.tag }}`
            - **npm**: https://www.npmjs.com/package/@asce1062/music-service-sdk/v/${{ steps.version.outputs.version }}

            ### Quality Checks âœ…
            - âœ“ Type checking passed
            - âœ“ Linting passed
            - âœ“ Tests passed with coverage
            - âœ“ Build successful (ESM, CJS, IIFE, DTS)
            - âœ“ Published to npm
            - âœ“ npm provenance enabled

            ### Installation
            ```bash
            npm install @asce1062/music-service-sdk@${{ steps.version.outputs.version }}
            ```

            ---

            ðŸ¤– This PR was automatically created by the [SDK Publishing Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Note**: After merging this PR, the git tag `sdk-v${{ steps.version.outputs.version }}` will be created automatically.
          branch: release/sdk-v${{ steps.version.outputs.version }}
          delete-branch: true
          labels: |
            release
            automated
            sdk
          assignees: ${{ github.actor }}

      - name: Add workflow summary
        if: inputs.dry_run != true
        run: |
          echo "## ðŸ“¦ Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: \`@asce1062/music-service-sdk\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **npm**: https://www.npmjs.com/package/@asce1062/music-service-sdk/v/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @asce1062/music-service-sdk@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Type checking passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Linting passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Tests passed with coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Build successful (ESM, CJS, IIFE, DTS)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ npm provenance enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request will be created to update package.json." >> $GITHUB_STEP_SUMMARY
          echo "After merging the PR, a git tag and GitHub release will be created automatically." >> $GITHUB_STEP_SUMMARY

      - name: Publish summary
        if: always()
        run: |
          echo "### SDK Publishing Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” This was a dry run - no changes were published" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Successfully published to npm!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View package: https://www.npmjs.com/package/@asce1062/music-service-sdk" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Publishing failed - check logs above" >> $GITHUB_STEP_SUMMARY
          fi
