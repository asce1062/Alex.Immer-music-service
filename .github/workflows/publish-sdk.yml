---
name: Publish SDK to npm

on:
  # Manual workflow dispatch for controlled releases
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type (patch, minor, major, or exact version like 1.0.0-beta.2)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
          - custom
      custom_version:
        description: "Custom version (only used if version=custom)"
        required: false
        type: string
      tag:
        description: "npm dist-tag (latest, beta, next, etc.)"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - beta
          - next
          - alpha
      dry_run:
        description: "Dry run (will not publish)"
        required: false
        default: false
        type: boolean

  # Automatic publishing on GitHub releases
  release:
    types: [published]

permissions:
  contents: write
  id-token: write # Required for npm provenance

jobs:
  publish:
    name: Publish SDK to npm
    runs-on: ubuntu-latest
    # Only run on main branch or release tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm for Trusted Publishers
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          cd packages/sdk

          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (e.g., sdk-v1.0.0 -> 1.0.0)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#sdk-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing from release: $VERSION"
          elif [ "${{ inputs.version }}" = "custom" ]; then
            echo "version=${{ inputs.custom_version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "Publishing custom version: ${{ inputs.custom_version }}"
          else
            # Smart version bumping for prereleases
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "Current version: $CURRENT_VERSION"

            if [ "${{ inputs.version }}" = "prerelease" ]; then
              # For prerelease bumps, use --preid to specify the tag
              npm version prerelease --preid=${{ inputs.tag }} --no-git-tag-version
            else
              # For other bumps (patch, minor, major)
              npm version ${{ inputs.version }} --no-git-tag-version
            fi

            NEW_VERSION=$(node -p "require('./package.json').version")
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
            echo "Publishing ${{ inputs.version }} bump: $CURRENT_VERSION -> $NEW_VERSION"
          fi

      - name: Update version in package.json
        if: github.event_name != 'release' && inputs.version == 'custom'
        run: |
          cd packages/sdk
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Run quality checks
        run: |
          cd packages/sdk
          echo "Running type checks..."
          npm run typecheck

          echo "Running linter..."
          npm run lint

          echo "Running format check..."
          npm run format:check

      - name: Run tests
        run: |
          cd packages/sdk
          echo "Running test suite..."
          npm run test:coverage

      - name: Build SDK
        run: |
          cd packages/sdk
          echo "Building SDK for all formats (ESM, CJS, IIFE, DTS)..."
          npm run build

      - name: Verify build artifacts
        run: |
          cd packages/sdk
          echo "Checking dist directory..."
          ls -lah dist/

          echo "Verifying required files exist..."
          test -f dist/index.js || (echo "Missing index.js" && exit 1)
          test -f dist/index.cjs || (echo "Missing index.cjs" && exit 1)
          test -f dist/index.d.ts || (echo "Missing index.d.ts" && exit 1)

          echo "âœ“ All build artifacts present"

      - name: Dry run publish
        if: inputs.dry_run == true
        run: |
          cd packages/sdk
          echo "DRY RUN: Would publish with:"
          npm publish --dry-run --tag ${{ steps.version.outputs.tag }}

      - name: Publish to npm
        if: inputs.dry_run != true
        run: |
          cd packages/sdk
          echo "Publishing @asce1062/music-service-sdk@${{ steps.version.outputs.version }} to npm..."
          npm publish --tag ${{ steps.version.outputs.tag }} --access public

          # Always update 'latest' tag to point to newest version
          echo "Updating 'latest' tag to point to ${{ steps.version.outputs.version }}..."
          npm dist-tag add @asce1062/music-service-sdk@${{ steps.version.outputs.version }} latest

      - name: Commit version bump
        if: github.event_name != 'release' && inputs.dry_run != true
        run: |
          git add packages/sdk/package.json
          git commit -m "chore(sdk): bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin ${{ github.ref_name }} || echo "No changes to push"

      - name: Create Git tag
        if: github.event_name != 'release' && inputs.dry_run != true
        run: |
          TAG_NAME="sdk-v${{ steps.version.outputs.version }}"
          git tag -a "$TAG_NAME" -m "SDK Release ${{ steps.version.outputs.version }}"
          git push origin "$TAG_NAME"

      - name: Generate release notes
        if: inputs.dry_run != true
        id: release_notes
        run: |
          cd packages/sdk

          echo "## ðŸ“¦ Published" >> notes.md
          echo "" >> notes.md
          echo "- **Package**: \`@asce1062/music-service-sdk\`" >> notes.md
          echo "- **Version**: \`${{ steps.version.outputs.version }}\`" >> notes.md
          echo "- **Tag**: \`${{ steps.version.outputs.tag }}\`" >> notes.md
          echo "- **npm**: https://www.npmjs.com/package/@asce1062/music-service-sdk/v/${{ steps.version.outputs.version }}" >> notes.md
          echo "" >> notes.md
          echo "## ðŸ“‹ Installation" >> notes.md
          echo "" >> notes.md
          echo "\`\`\`bash" >> notes.md
          echo "npm install @asce1062/music-service-sdk@${{ steps.version.outputs.version }}" >> notes.md
          echo "\`\`\`" >> notes.md
          echo "" >> notes.md
          echo "## âœ… Quality Checks" >> notes.md
          echo "" >> notes.md
          echo "- âœ“ Type checking passed" >> notes.md
          echo "- âœ“ Linting passed" >> notes.md
          echo "- âœ“ Tests passed with coverage" >> notes.md
          echo "- âœ“ Build successful (ESM, CJS, IIFE, DTS)" >> notes.md
          echo "- âœ“ npm provenance enabled" >> notes.md

          cat notes.md >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        if: github.event_name != 'release' && inputs.dry_run != true
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: sdk-v${{ steps.version.outputs.version }}
          release_name: SDK v${{ steps.version.outputs.version }}
          body_path: packages/sdk/notes.md
          draft: false
          prerelease: ${{ steps.version.outputs.tag != 'latest' }}

      - name: Publish summary
        if: always()
        run: |
          echo "### SDK Publishing Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” This was a dry run - no changes were published" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Successfully published to npm!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View package: https://www.npmjs.com/package/@asce1062/music-service-sdk" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Publishing failed - check logs above" >> $GITHUB_STEP_SUMMARY
          fi
