name: Monorepo CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:


env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ============================================================================
  # Setup and Cache
  # ============================================================================
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    outputs:
      python-cache-key: ${{ steps.python-cache.outputs.cache-hit }}
      node-cache-key: ${{ steps.node-cache.outputs.cache-hit }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      id: python-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Cache Node dependencies
      id: node-cache
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

  # ============================================================================
  # Python Checks
  # ============================================================================
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Format check (Black)
      run: black --check scripts/

    - name: Import sorting check (isort)
      run: isort --check-only scripts/

    - name: Lint (Ruff)
      run: ruff check scripts/

  python-type-check:
    name: Python Type Checking
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Type check (mypy)
      run: mypy scripts/utils/ --config-file=pyproject.toml --ignore-missing-imports

  python-security:
    name: Python Security
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Security scan (bandit)
      run: bandit -r scripts/ -c pyproject.toml

    - name: Vulnerability check (pip-audit)
      run: |
        pip install pip-audit
        pip-audit || true

  python-dead-code:
    name: Python Dead Code Detection
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install vulture

    - name: Find dead code (vulture)
      run: vulture scripts/ --min-confidence=95 --exclude=scripts/tests/

  python-test:
    name: Python Tests
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        python-version: [ "3.11", "3.12" ]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests with coverage
      run: pytest scripts/tests/ --cov=scripts/utils --cov-report=xml --cov-report=term-missing

    - name: Upload Python coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: python-${{ matrix.os }}-py${{ matrix.python-version }}
        name: python-coverage

  # ============================================================================
  # TypeScript/JavaScript Checks
  # ============================================================================
  typescript-quality:
    name: TypeScript Code Quality
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Format check (Prettier)
      run: npm run format:check:ts

    - name: Lint (ESLint)
      run: npm run lint:ts

  typescript-type-check:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Type check (tsc)
      run: npm run type-check:ts

  typescript-dead-code:
    name: TypeScript Dead Code Detection
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Find dead code (Knip)
      run: npm run dead-code:ts

  typescript-security:
    name: TypeScript Security
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Security audit (npm audit)
      run: npm audit --audit-level=moderate || true

  typescript-test:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Run tests with coverage
      run: npm run test:coverage:ts

    - name: Upload TypeScript coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/coverage-final.json
        flags: typescript
        name: typescript-coverage

  # ============================================================================
  # Turborepo Build
  # ============================================================================
  turbo-build:
    name: Turborepo Build
    runs-on: ubuntu-latest
    needs: [ python-quality, typescript-quality ]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Build all workspaces
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          api/dist
          web/.output

  # ============================================================================
  # All Checks Passed
  # ============================================================================
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
    - python-quality
    - python-type-check
    - python-security
    - python-test
    - typescript-quality
    - typescript-type-check
    - typescript-security
    - typescript-test
    - turbo-build
    if: always()
    steps:
    - name: Check if all required jobs passed
      run: |
        if [[ "${{ needs.python-quality.result }}" != "success" ]] || \
           [[ "${{ needs.python-type-check.result }}" != "success" ]] || \
           [[ "${{ needs.python-security.result }}" != "success" ]] || \
           [[ "${{ needs.python-test.result }}" != "success" ]] || \
           [[ "${{ needs.typescript-quality.result }}" != "success" ]] || \
           [[ "${{ needs.typescript-type-check.result }}" != "success" ]] || \
           [[ "${{ needs.typescript-security.result }}" != "success" ]] || \
           [[ "${{ needs.typescript-test.result }}" != "success" ]] || \
           [[ "${{ needs.turbo-build.result }}" != "success" ]]; then
          echo "❌ One or more required checks failed"
          exit 1
        fi
        echo "✅ All required checks passed!"
